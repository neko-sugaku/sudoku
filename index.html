<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°ç‹¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 2rem; /* p-8 */
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: min(90vw, 500px); /* Responsive width */
            height: min(90vw, 500px); /* Keep aspect ratio */
            border: 3px solid #374151; /* Border for the entire grid */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .cell {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1rem, 4vw, 2rem); /* Responsive font size */
            font-weight: 600;
            border: 1px solid #d1d5db; /* Light gray border for cells */
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            user-select: none; /* Prevent text selection */
        }
        .cell.prefilled {
            background-color: #e5e7eb; /* Gray background for pre-filled cells */
            color: #1f2937; /* Darker text for pre-filled */
            cursor: default;
        }
        .cell.selected {
            border: 2px solid #3b82f6; /* Blue border for selected cell */
            box-shadow: 0 0 0 2px #3b82f6; /* Blue shadow for selected cell */
        }
        .cell.invalid {
            background-color: #fee2e2; /* Light red for invalid input */
            color: #dc2626; /* Dark red text for invalid */
        }
        /* Borders for 3x3 blocks */
        .cell:nth-child(3n) { border-right: 2px solid #374151; }
        .cell:nth-child(9n) { border-right: 3px solid #374151; } /* Outer right border */
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #374151;
        }
        .cell:nth-child(n+1):nth-child(-n+9) { border-top: 3px solid #374151; } /* Outer top border */
        .cell:nth-child(n+73):nth-child(-n+81) { border-bottom: 3px solid #374151; } /* Outer bottom border */
        .cell:nth-child(9n+1) { border-left: 3px solid #374151; } /* Outer left border */

        .difficulty-buttons button {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            margin: 0.5rem; /* m-2 */
            border: none;
            cursor: pointer;
        }
        .difficulty-buttons button:hover {
            transform: translateY(-2px);
        }
        .difficulty-buttons button:active {
            transform: translateY(0);
        }

        /* Difficulty button colors */
        .difficulty-buttons .easy {
            background-color: #60a5fa; /* blue-400 */
            color: white;
        }
        .difficulty-buttons .easy.selected {
            background-color: #2563eb; /* blue-600 */
        }
        .difficulty-buttons .medium {
            background-color: #4ade80; /* green-400 */
            color: white;
        }
        .difficulty-buttons .medium.selected {
            background-color: #16a34a; /* green-600 */
        }
        .difficulty-buttons .hard {
            background-color: #f87171; /* red-400 */
            color: white;
        }
        .difficulty-buttons .hard.selected {
            background-color: #ef4444; /* red-600 */
        }

        .input-buttons button {
            padding: 0.75rem 1.25rem; /* py-3 px-5 */
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            background-color: #e0f2fe; /* light blue-100 */
            color: #0c4a6e; /* cyan-900 */
            border: 2px solid #7dd3fc; /* sky-300 */
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: all 0.2s ease;
            margin: 0.25rem; /* m-1 */
            cursor: pointer;
        }
        .input-buttons button:hover {
            background-color: #bae6fd; /* light blue-200 */
            transform: translateY(-1px);
        }
        .input-buttons button:active {
            background-color: #7dd3fc; /* sky-300 */
            transform: translateY(0);
        }
        .input-buttons .erase-button {
            background-color: #fecaca; /* red-200 */
            color: #b91c1c; /* red-700 */
            border-color: #ef4444; /* red-500 */
        }
        .input-buttons .erase-button:hover {
            background-color: #fca5a5; /* red-300 */
        }
        .input-buttons .erase-button:active {
            background-color: #ef4444; /* red-500 */
        }

        .timer {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #374151; /* gray-700 */
            margin-top: 1rem; /* mt-4 */
        }

        /* Modal for win message */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            padding: 3rem; /* p-12 */
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            max-width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h2 {
            font-size: 3rem; /* text-5xl */
            font-weight: 800; /* font-extrabold */
            color: #f59e0b; /* amber-500 */
            margin-bottom: 1rem; /* mb-4 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .modal-content p {
            font-size: 1.5rem; /* text-2xl */
            color: #4b5563; /* gray-700 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .modal-content button {
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 9999px; /* rounded-full */
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 700; /* font-bold */
            font-size: 1.125rem; /* text-lg */
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .modal-content button:hover {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-2px);
        }
        .modal-content button:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .game-container {
                padding: 1rem;
            }
            .difficulty-buttons {
                flex-direction: column;
            }
            .input-buttons {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }
            .input-buttons button {
                padding: 0.5rem 0.75rem;
                font-size: 1rem;
            }
            .timer {
                font-size: 1.25rem;
            }
            .modal-content h2 {
                font-size: 2rem;
            }
            .modal-content p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6">æ•°ç‹¬ã‚²ãƒ¼ãƒ </h1>

        <div class="difficulty-buttons flex justify-center mb-8">
            <button id="easyBtn" class="easy">åˆç´š</button>
            <button id="mediumBtn" class="medium">ä¸­ç´š</button>
            <button id="hardBtn" class="hard">ä¸Šç´š</button>
        </div>

        <div id="sudokuGrid" class="sudoku-grid">
            <!-- Sudoku cells will be generated here by JavaScript -->
        </div>

        <div class="input-buttons flex flex-wrap justify-center mb-4">
            <button class="number-btn" data-value="1">1</button>
            <button class="number-btn" data-value="2">2</button>
            <button class="number-btn" data-value="3">3</button>
            <button class="number-btn" data-value="4">4</button>
            <button class="number-btn" data-value="5">5</button>
            <button class="number-btn" data-value="6">6</button>
            <button class="number-btn" data-value="7">7</button>
            <button class="number-btn" data-value="8">8</button>
            <button class="number-btn" data-value="9">9</button>
            <button class="erase-button" data-value="0">æ¶ˆå»</button>
        </div>

        <div id="timer" class="timer">æ™‚é–“: 00:00</div>
    </div>

    <!-- Win Modal -->
    <div id="winModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-5xl font-extrabold text-amber-500 mb-4">ğŸ’® èŠ±ä¸¸ï¼ ğŸ’®</h2>
            <p id="clearTimeMessage" class="text-2xl text-gray-700 mb-6"></p>
            <p class="text-xl text-gray-600 mb-8">
                ç´ æ™´ã‚‰ã—ã„ï¼ã‚ãªãŸã¯æ•°ç‹¬ã®é”äººã§ã™ã­ï¼
                é©šãã¹ãé›†ä¸­åŠ›ã¨è«–ç†çš„æ€è€ƒåŠ›ã§ã€è¦‹äº‹ã«ãƒ‘ã‚ºãƒ«ã‚’è§£ãæ˜ã‹ã—ã¾ã—ãŸï¼
                æœ¬å½“ã«ã™ã”ã„ã§ã™ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰
            </p>
            <button id="closeModalBtn">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const sudokuGridElement = document.getElementById('sudokuGrid');
        const difficultyButtons = document.querySelectorAll('.difficulty-buttons button');
        const numberButtons = document.querySelectorAll('.number-btn');
        const eraseButton = document.querySelector('.erase-button');
        const timerElement = document.getElementById('timer');
        const winModalOverlay = document.getElementById('winModalOverlay');
        const clearTimeMessage = document.getElementById('clearTimeMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹å¤‰æ•°
        let selectedCell = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚»ãƒ«
        let board = []; // ç¾åœ¨ã®æ•°ç‹¬ãƒœãƒ¼ãƒ‰ã®çŠ¶æ…‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å«ã‚€)
        let solution = []; // æ•°ç‹¬ã®å”¯ä¸€ã®è§£
        let prefilledCells = new Set(); // æœ€åˆã‹ã‚‰åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let timerInterval = null; // ã‚¿ã‚¤ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID
        let startTime = 0; // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚åˆ»
        let currentDifficulty = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹é›£æ˜“åº¦ ('easy', 'medium', 'hard')
        let selectedDifficultyButton = null; // é¸æŠä¸­ã®é›£æ˜“åº¦ãƒœã‚¿ãƒ³è¦ç´ 

        // é›£æ˜“åº¦ã”ã¨ã®åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã®æ•° (ç›®å®‰)
        const difficultyLevels = {
            easy: { min: 38, max: 50, target: 45 },
            medium: { min: 32, max: 37, target: 35 },
            hard: { min: 28, max: 31, target: 30 }
        };

        // æ•°ç‹¬ã®ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã—ã¦æç”»ã™ã‚‹é–¢æ•°
        function initializeBoard() {
            sudokuGridElement.innerHTML = ''; // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
            selectedCell = null; // é¸æŠã‚»ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            board = Array(9).fill(0).map(() => Array(9).fill(0)); // ãƒœãƒ¼ãƒ‰ã‚’0ã§åˆæœŸåŒ–
            prefilledCells.clear(); // åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã‚’ã‚¯ãƒªã‚¢

            // 9x9ã®ã‚»ãƒ«ã‚’ä½œæˆã—ã€ã‚°ãƒªãƒƒãƒ‰ã«è¿½åŠ 
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', handleCellClick);
                    sudokuGridElement.appendChild(cell);
                }
            }
        }

        // æ•°ç‹¬ã®ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
        function handleCellClick(event) {
            const clickedCell = event.target;

            // æ—¢ã«åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã¯é¸æŠã§ããªã„
            if (clickedCell.classList.contains('prefilled')) {
                return;
            }

            // ä»¥å‰é¸æŠã•ã‚Œã¦ã„ãŸã‚»ãƒ«ãŒã‚ã‚Œã°ã€é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
            if (selectedCell) {
                selectedCell.classList.remove('selected');
            }

            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚»ãƒ«ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            selectedCell = clickedCell;
            selectedCell.classList.add('selected');
        }

        // æ•°å­—ãƒœã‚¿ãƒ³ã¾ãŸã¯æ¶ˆå»ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
        function handleNumberInput(event) {
            if (!selectedCell) {
                return; // ã‚»ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            }

            const value = parseInt(event.target.dataset.value);
            const row = parseInt(selectedCell.dataset.row);
            const col = parseInt(selectedCell.dataset.col);

            // åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã¯å¤‰æ›´ã§ããªã„
            if (prefilledCells.has(row * 9 + col)) {
                return;
            }

            // ã‚»ãƒ«ã«å€¤ã‚’è¨­å®š
            board[row][col] = value;
            selectedCell.textContent = value === 0 ? '' : value; // 0ãªã‚‰ç©ºã€ãã‚Œä»¥å¤–ãªã‚‰æ•°å­—

            // å…¥åŠ›ã•ã‚ŒãŸå€¤ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
            if (value !== 0 && !isValidPlacement(board, value, row, col)) {
                selectedCell.classList.add('invalid');
            } else {
                selectedCell.classList.remove('invalid');
            }

            // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢åˆ¤å®š
            checkWinCondition();
        }

        // æ•°ç‹¬ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã€æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«æ•°å­—ã‚’é…ç½®ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function isValidPlacement(currentBoard, num, row, col) {
            // è¡Œã®ãƒã‚§ãƒƒã‚¯
            for (let x = 0; x < 9; x++) {
                if (x !== col && currentBoard[row][x] === num) {
                    return false;
                }
            }

            // åˆ—ã®ãƒã‚§ãƒƒã‚¯
            for (let x = 0; x < 9; x++) {
                if (x !== row && currentBoard[x][col] === num) {
                    return false;
                }
            }

            // 3x3ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒã‚§ãƒƒã‚¯
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if ((startRow + i !== row || startCol + j !== col) && currentBoard[startRow + i][startCol + j] === num) {
                        return false;
                    }
                }
            }
            return true;
        }

        // æ•°ç‹¬ãƒœãƒ¼ãƒ‰å…¨ä½“ãŒæœ‰åŠ¹ãªçŠ¶æ…‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•° (è§£ã®æ¤œè¨¼ç”¨)
        function isValidSudoku(currentBoard) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const num = currentBoard[r][c];
                    if (num !== 0 && !isValidPlacement(currentBoard, num, r, c)) {
                        return false;
                    }
                }
            }
            return true;
        }

        // æ•°ç‹¬ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°)
        // ã“ã®é–¢æ•°ã¯ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè§£ã‚’æŒã¤æ•°ç‹¬ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨è©¦ã¿ã¾ã™ã€‚
        // å®Œå…¨ãªãƒ¦ãƒ‹ãƒ¼ã‚¯è§£ä¿è¨¼ã¯è¤‡é›‘ãªãŸã‚ã€ã“ã“ã§ã¯ä¸€èˆ¬çš„ãªç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¨ã€
        // ç”Ÿæˆå¾Œã«è§£ãŒä¸€ã¤ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ç°¡æ˜“çš„ãªãƒã‚§ãƒƒã‚¯ã‚’çµ„ã¿åˆã‚ã›ã¾ã™ã€‚
        // å³å¯†ãªãƒ¦ãƒ‹ãƒ¼ã‚¯è§£ç”Ÿæˆã¯ã€ã•ã‚‰ã«é«˜åº¦ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒå¿…è¦ã§ã™ã€‚
        function generateSudoku(difficulty) {
            const numCellsToFill = difficultyLevels[difficulty].target;
            let tempBoard = Array(9).fill(0).map(() => Array(9).fill(0));
            let tempSolution = Array(9).fill(0).map(() => Array(9).fill(0));

            // å®Œå…¨ã«åŸ‹ã¾ã£ãŸãƒœãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            fillGrid(tempBoard);
            // ç”Ÿæˆã•ã‚ŒãŸãƒœãƒ¼ãƒ‰ã‚’è§£ã¨ã—ã¦ä¿å­˜
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    tempSolution[r][c] = tempBoard[r][c];
                }
            }

            let cellsToRemove = 81 - numCellsToFill;
            let removedCount = 0;
            let attempts = 0;
            const maxAttempts = 5000; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚ã®æœ€å¤§è©¦è¡Œå›æ•°

            // ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºã§ã‚»ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é…åˆ—ã‚’ä½œæˆ
            const allCellIndices = [];
            for (let i = 0; i < 81; i++) {
                allCellIndices.push(i);
            }
            shuffleArray(allCellIndices); // ã‚·ãƒ£ãƒƒãƒ•ãƒ«

            let currentPuzzle = JSON.parse(JSON.stringify(tempBoard)); // ä½œæ¥­ç”¨ãƒ‘ã‚ºãƒ«

            while (removedCount < cellsToRemove && attempts < maxAttempts) {
                attempts++;
                if (allCellIndices.length === 0) break; // å‰Šé™¤ã™ã‚‹ã‚»ãƒ«ãŒãªããªã£ãŸã‚‰çµ‚äº†

                const cellIndex = allCellIndices.pop(); // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚»ãƒ«ã‚’é¸æŠ
                const r = Math.floor(cellIndex / 9);
                const c = cellIndex % 9;

                if (currentPuzzle[r][c] === 0) continue; // æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                const originalValue = currentPuzzle[r][c];
                currentPuzzle[r][c] = 0; // ä¸€æ™‚çš„ã«å‰Šé™¤

                // ã“ã®çŠ¶æ…‹ã®ãƒ‘ã‚ºãƒ«ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè§£ã‚’æŒã¤ã‹ãƒã‚§ãƒƒã‚¯
                const solutionsFound = [0]; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’é…åˆ—ã§æ¸¡ã™ (å‚ç…§æ¸¡ã—ã®ã‚ˆã†ã«æ‰±ã†ãŸã‚)
                const testBoard = JSON.parse(JSON.stringify(currentPuzzle)); // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒœãƒ¼ãƒ‰
                solveSudokuAndCount(testBoard, solutionsFound);

                if (solutionsFound[0] === 1) {
                    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè§£ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€å‰Šé™¤ã‚’ç¢ºå®š
                    removedCount++;
                } else {
                    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè§£ã§ã¯ãªã„å ´åˆã€å…ƒã«æˆ»ã™
                    currentPuzzle[r][c] = originalValue;
                }
            }

            // æœ€çµ‚çš„ãªãƒœãƒ¼ãƒ‰ã¨è§£ã‚’è¨­å®š
            board = currentPuzzle;
            solution = tempSolution;

            // åŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã‚’ç‰¹å®š
            prefilledCells.clear();
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] !== 0) {
                        prefilledCells.add(r * 9 + c);
                    }
                }
            }
        }

        // ãƒœãƒ¼ãƒ‰ã‚’å®Œå…¨ã«åŸ‹ã‚ã‚‹ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–¢æ•°
        function fillGrid(grid) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (grid[r][c] === 0) {
                        const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                        shuffleArray(numbers); // ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºã§è©¦è¡Œ

                        for (const num of numbers) {
                            if (isValidPlacement(grid, num, r, c)) {
                                grid[r][c] = num;
                                if (fillGrid(grid)) {
                                    return true;
                                }
                                grid[r][c] = 0; // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
                            }
                        }
                        return false; // ã©ã®æ•°å­—ã‚‚é…ç½®ã§ããªã„
                    }
                }
            }
            return true; // ã™ã¹ã¦ã®ã‚»ãƒ«ãŒåŸ‹ã¾ã£ãŸ
        }

        // æ•°ç‹¬ã‚’è§£ãã€è§£ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–¢æ•°
        function solveSudokuAndCount(grid, solutionsFound) {
            if (solutionsFound[0] > 1) { // è¤‡æ•°ã®è§£ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãã‚Œä»¥ä¸Šæ¢ç´¢ã—ãªã„
                return;
            }

            let emptyCell = findEmpty(grid);
            if (!emptyCell) {
                solutionsFound[0]++; // è§£ãŒè¦‹ã¤ã‹ã£ãŸ
                return;
            }

            const [row, col] = emptyCell;
            for (let num = 1; num <= 9; num++) {
                if (isValidPlacement(grid, num, row, col)) {
                    grid[row][col] = num;
                    solveSudokuAndCount(grid, solutionsFound);
                    grid[row][col] = 0; // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
                }
            }
        }

        // ç©ºã®ã‚»ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function findEmpty(grid) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (grid[r][c] === 0) {
                        return [r, c];
                    }
                }
            }
            return null;
        }

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•° (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // ãƒœãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderBoard() {
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    const cell = sudokuGridElement.children[i * 9 + j];
                    const value = board[i][j];
                    cell.textContent = value === 0 ? '' : value;
                    cell.classList.remove('prefilled', 'selected', 'invalid');

                    if (prefilledCells.has(i * 9 + j)) {
                        cell.classList.add('prefilled');
                    }
                }
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startTimer() {
            clearInterval(timerInterval); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            startTime = Date.now(); // ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²
            timerInterval = setInterval(updateTimer, 1000); // 1ç§’ã”ã¨ã«æ›´æ–°
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTimer() {
            const elapsedTime = Date.now() - startTime;
            const seconds = Math.floor(elapsedTime / 1000) % 60;
            const minutes = Math.floor(elapsedTime / 1000 / 60);

            const formattedTime =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.textContent = `æ™‚é–“: ${formattedTime}`;
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
        function stopTimer() {
            clearInterval(timerInterval);
        }

        // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function checkWinCondition() {
            // ã™ã¹ã¦ã®ã‚»ãƒ«ãŒåŸ‹ã¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0) {
                        return; // ç©ºã®ã‚»ãƒ«ãŒã‚ã‚Œã°ã¾ã ã‚¯ãƒªã‚¢ã§ã¯ãªã„
                    }
                }
            }

            // ã™ã¹ã¦ã®ã‚»ãƒ«ãŒåŸ‹ã¾ã£ã¦ã„ã‚‹å ´åˆã€è§£ã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] !== solution[r][c]) {
                        // è§£ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ã€ä¸æ­£è§£ãªã®ã§ä½•ã‚‚ã—ãªã„
                        return;
                    }
                }
            }

            // ã“ã“ã«åˆ°é”ã—ãŸã‚‰ã‚¯ãƒªã‚¢ï¼
            stopTimer();
            const finalTime = timerElement.textContent.replace('æ™‚é–“: ', '');
            clearTimeMessage.textContent = `ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ : ${finalTime}`;
            winModalOverlay.classList.add('show');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
        closeModalBtn.addEventListener('click', () => {
            winModalOverlay.classList.remove('show');
            resetGame();
        });

        // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetGame() {
            stopTimer();
            timerElement.textContent = 'æ™‚é–“: 00:00';
            initializeBoard();
            // é›£æ˜“åº¦é¸æŠãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            difficultyButtons.forEach(btn => btn.classList.remove('selected'));
            selectedDifficultyButton = null;
            currentDifficulty = null;
        }

        // é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const difficulty = button.id.replace('Btn', '');

                if (selectedDifficultyButton === button) {
                    // åŒã˜ãƒœã‚¿ãƒ³ãŒ2å›ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€ã‚²ãƒ¼ãƒ é–‹å§‹
                    startGame(difficulty);
                } else {
                    // ç•°ãªã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                    if (selectedDifficultyButton) {
                        selectedDifficultyButton.classList.remove('selected');
                    }
                    button.classList.add('selected');
                    selectedDifficultyButton = button;
                    currentDifficulty = difficulty;
                    // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ãªã®ã§ãƒœãƒ¼ãƒ‰ã¯åˆæœŸåŒ–ã®ã¿
                    initializeBoard();
                    stopTimer();
                    timerElement.textContent = 'æ™‚é–“: 00:00';
                }
            });
        });

        // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startGame(difficulty) {
            if (!difficulty) {
                console.error("é›£æ˜“åº¦ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            console.log(`${difficulty}ãƒ¢ãƒ¼ãƒ‰ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
            initializeBoard(); // ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
            generateSudoku(difficulty); // æ•°ç‹¬ã‚’ç”Ÿæˆ
            renderBoard(); // ç”Ÿæˆã•ã‚ŒãŸæ•°ç‹¬ã‚’æç”»
            startTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        }

        // æ•°å­—å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        numberButtons.forEach(button => {
            button.addEventListener('click', handleNumberInput);
        });

        // æ¶ˆå»ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        eraseButton.addEventListener('click', handleNumberInput);

        // åˆæœŸãƒœãƒ¼ãƒ‰ã®æç”»
        initializeBoard();

    </script>
</body>
</html>

